asyncapi: 3.0.0
info:
  title: "Hub Sant\xE9 - Mod\xE8les"
  version: '1.0'
  description: "Le Hub Sant\xE9 permet le partage d'informations entre acteurs du\
    \ monde de la Sant\xE9.\n"
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0
defaultContentType: application/json
servers:
  bac-a-sable:
    host: messaging.bac-a-sable.hub.esante.gouv.fr:5671
    protocol: amqps
    protocolVersion: 0-9-1
    description: "Instance \"bac \xE0 sable\" du Hub Sante d\xE9ploy\xE9e dans le\
      \ Cloud."
    security:
    - $ref: '#/components/securitySchemes/tlsAuthIGCTest'
  pre-prod:
    host: messaging.pre-prod.hub.esante.gouv.fr:5671
    protocol: amqps
    protocolVersion: 0-9-1
    description: "Instance \"pr\xE9-prod\" du Hub Sante d\xE9ploy\xE9e dans le Cloud."
    security:
    - $ref: '#/components/securitySchemes/tlsAuthIGC'
  prod:
    host: messaging.hub.esante.gouv.fr:5671
    protocol: amqps
    protocolVersion: 0-9-1
    description: "Instance de production du Hub Sante d\xE9ploy\xE9e dans le Cloud."
    security:
    - $ref: '#/components/securitySchemes/tlsAuthIGC'
channels:
  '{clientId}':
    address: '{clientId}'
    messages:
      edxlMessage:
        $ref: '#/components/messages/edxlMessage'
    description: "Exchange d'entr\xE9e avec un topic sp\xE9cifique \xE0 chaque client\
      \ (routingKey \xE9gale \xE0 son clientId) pour l'envoi de tous les messages"
    parameters:
      clientId:
        $ref: '#/components/parameters/clientId'
    bindings:
      amqp:
        is: routingKey
        exchange:
          name: hubsante
          type: topic
          durable: true
          autoDelete: false
          vhost: /
  '{clientId}.message':
    address: '{clientId}.message'
    messages:
      edxlMessage:
        $ref: '#/components/messages/edxlMessage'
    description: "File sp\xE9cifique \xE0 chaque client pour la r\xE9ception de messages\
      \ fonctionnels"
    parameters:
      clientId:
        $ref: '#/components/parameters/clientId'
    bindings:
      amqp:
        is: queue
        queue:
          name: '{clientId}.message'
          durable: true
          exclusive: false
          autoDelete: false
          vhost: /
  '{clientId}.ack':
    address: '{clientId}.ack'
    messages:
      edxlMessage:
        $ref: '#/components/messages/edxlMessage'
    description: "File sp\xE9cifique \xE0 chaque client pour la r\xE9ception des acquittements\
      \ de r\xE9ception finale"
    parameters:
      clientId:
        $ref: '#/components/parameters/clientId'
    bindings:
      amqp:
        is: queue
        queue:
          name: '{clientId}.ack'
          durable: true
          exclusive: false
          autoDelete: false
          vhost: /
  '{clientId}.info':
    address: '{clientId}.info'
    messages:
      edxlMessage:
        $ref: '#/components/messages/edxlMessage'
    description: "File sp\xE9cifique \xE0 chaque client pour la r\xE9ception des informations\
      \ et erreurs compl\xE9mentaires li\xE9es au fonctionnement et aux \xE9changes\
      \ port\xE9s par le Hub Sant\xE9"
    parameters:
      clientId:
        $ref: '#/components/parameters/clientId'
    bindings:
      amqp:
        is: queue
        queue:
          name: '{clientId}.info'
          durable: true
          exclusive: false
          autoDelete: false
          vhost: /
operations:
  publish:
    title: Publication
    summary: "Publication de tous les types de messages sur le Hub Sant\xE9"
    action: send
    channel:
      $ref: '#/channels/{clientId}'
    messages:
    - $ref: '#/channels/{clientId}/messages/edxlMessage'
    bindings:
      amqp:
        expiration: 86400000
        userId: '{clientId}'
        cc:
        - '{clientId}'
        deliveryMode: 2
        mandatory: true
        ack: true
  receiveMessage:
    title: "R\xE9ception de messages fonctionnels"
    action: receive
    channel:
      $ref: '#/channels/{clientId}.message'
    messages:
    - $ref: '#/channels/{clientId}.message/messages/edxlMessage'
    bindings:
      amqp:
        expiration: 86400000
        userId: '{otherClientId}'
        cc:
        - '{otherClientId}'
        deliveryMode: 2
        mandatory: true
        ack: true
  receiveAck:
    title: "R\xE9ception de messages d'acquittement de r\xE9ception finale"
    action: receive
    channel:
      $ref: '#/channels/{clientId}.ack'
    messages:
    - $ref: '#/channels/{clientId}.ack/messages/edxlMessage'
    bindings:
      amqp:
        expiration: 86400000
        userId: '{otherClientId}'
        cc:
        - '{otherClientId}'
        deliveryMode: 2
        mandatory: true
        ack: true
  receiveInfo:
    title: "R\xE9ception de messages d'info"
    action: receive
    channel:
      $ref: '#/channels/{clientId}.info'
    messages:
    - $ref: '#/channels/{clientId}.info/messages/edxlMessage'
    bindings:
      amqp:
        expiration: 86400000
        userId: '{otherClientId}'
        cc:
        - '{otherClientId}'
        deliveryMode: 2
        mandatory: true
        ack: true
components:
  securitySchemes:
    tlsAuthIGC:
      type: X509
      description: "Un certificat SSL_SERV sign\xE9 par l'IGC Sant\xE9 PROD est n\xE9\
        cessaire pour l'authentification mTLS"
    tlsAuthIGCTest:
      type: X509
      description: "Un certificat SSL_SERV sign\xE9 par l'IGC Sant\xE9 TEST est n\xE9\
        cessaire pour l'authentification mTLS"
  parameters:
    clientId:
      description: L'identifiant du client
    otherClientId:
      description: "L'identifiant d'un autre client du Hub Sant\xE9"
  messages:
    edxlMessage:
      title: Message au standard EDXL
      summary: "Message au standard EDXL transportable par le Hub, comportant une\
        \ partie adressage et une partie contenu. La partie contenu peut respecter\
        \ diff\xE9rentes sp\xE9cifications fonctionnelles."
      headers:
        type: object
        properties:
          correlationId:
            description: Correlation ID set by application
            type: string
          applicationInstanceId:
            description: Unique identifier for a given instance of the publishing
              application
            type: string
      payload:
        $ref: '#/components/schemas/EdxlMessage'
  schemas:
    EdxlMessage:
      properties:
        distributionID:
          type: string
        senderID:
          type: string
        dateTimeSent:
          type: string
          format: date-time
        dateTimeExpires:
          type: string
          format: date-time
        distributionStatus:
          $ref: '#/components/schemas/DistributionStatus'
        distributionKind:
          $ref: '#/components/schemas/DistributionKind'
        descriptor:
          $ref: '#/components/schemas/Descriptor'
        content:
          $ref: '#/components/schemas/Content'
      additionalProperties: false
      required:
      - distributionID
      - senderID
      - dateTimeSent
      - dateTimeExpires
      - distributionStatus
      - distributionKind
      - descriptor
      - content
    DistributionStatus:
      type: string
      enum:
      - Actual
      - Exercise
      - System
      - Test
      - Unknown
      - NoAppropriateDefault
    DistributionKind:
      type: string
      enum:
      - Report
      - Update
      - Cancel
      - Request
      - Response
      - Dispatch
      - Ack
      - Error
      - SensorConfiguration
      - SensorControl
      - SensorStatus
      - SensorDetection
      - Unknown
      - NoAppropriateDefault
    Descriptor:
      properties:
        language:
          type: string
        explicitAddress:
          $ref: '#/components/schemas/ExplicitAddress'
      additionalProperties: false
      required:
      - language
      - explicitAddress
    ExplicitAddress:
      properties:
        explicitAddressScheme:
          type: string
        explicitAddressValue:
          type: string
      additionalProperties: false
      required:
      - explicitAddressScheme
      - explicitAddressValue
    Content:
      properties:
        contentObject:
          $ref: '#/components/schemas/ContentObject'
      additionalProperties: false
      required:
      - contentObject
    ContentObject:
      oneOf:
      - $ref: '#/components/schemas/JsonContent'
      - $ref: '#/components/schemas/ContentXML'
    JsonContent:
      properties:
        JsonContent:
          $ref: '#/components/schemas/EmbeddedJsonContent'
    ContentXML:
      properties:
        contentXML:
          $ref: '#/components/schemas/EmbeddedXMLContent'
    EmbeddedJsonContent:
      oneOf: &id001
      - $ref: '#/components/schemas/DistributionElement'
    EmbeddedXMLContent:
      oneOf: *id001
    DistributionElement:
      $id: classpath:/json-schema/schema#
      x-id: RC-DE.schema.json#
      example: example.json#
      type: object
      title: DistributionElement
      required:
      - messageId
      - sender
      - sentAt
      - kind
      - status
      - recipient
      properties:
        messageId:
          type: string
          title: Identifiant du message
          x-health-only: false
          x-cols: 6
          example: example.json#/messageId
          description: "Identifiant partag\xE9 de l'affaire/dossier, g\xE9n\xE9r\xE9\
            \ une seule fois par le syst\xE8me du partenaire qui recoit la primo-demande\
            \ de secours (cr\xE9ateur du dossier). \nIl est valoris\xE9 comme suit\
            \ lors de sa cr\xE9ation : \n{pays}.{domaine}.{organisation}.{senderCaseId}\n\
            \nIl doit pouvoir \xEAtre g\xE9n\xE9r\xE9 de fa\xE7on d\xE9centralis\xE9\
            e et ne pr\xE9senter aucune ambigu\xEFt\xE9.\n Il doit \xEAtre unique\
            \ dans l'ensemble des syst\xE8mes : le num\xE9ro de dossier fourni par\
            \ celui qui g\xE9n\xE8re l'identifiant partag\xE9 doit donc \xEAtre un\
            \ num\xE9ro unique dans son syst\xE8me."
          examples:
          - d350c9d2-9d76-4568-b0b7-a747ffadc949
        sender:
          $ref: '#/components/schemas/sender'
        sentAt:
          type: string
          title: Horodatage envoi message
          x-health-only: false
          x-cols: 6
          example: example.json#/sentAt
          description: "Groupe date heure de d\xE9but de partage li\xE9 \xE0 l'envoi\
            \ du message. Il doit  \xEAtre coh\xE9rent avec le champ <dateTimeSent>\
            \ de l'enveloppe EDXL (voir DST).  L'indicateur de fuseau horaire Z ne\
            \ doit pas \xEAtre utilis\xE9. Le fuseau horaire pour UTC doit \xEAtre\
            \ repr\xE9sent\xE9 par '-00:00'"
          pattern: ^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}[\-+]\d{2}:\d{2}$
          format: date-time
          examples:
          - None
        kind:
          type: string
          title: Type de message
          x-health-only: false
          x-cols: 6
          example: example.json#/kind
          description: Prend la valeur <distributionKind de l'enveloppe EDXL (voir
            DST)
          enum:
          - Report
          - Update
          - Cancel
          - Ack
          - Error
          examples:
          - ALERT
        status:
          type: string
          title: Statut du message
          x-health-only: false
          x-cols: 6
          example: example.json#/status
          description: Prend la valeur <distributionStatus> de l'enveloppe EDXL (voir
            DST)
          enum:
          - Actual
          - Exercise
          - System
          examples:
          - ACTUAL
        recipient:
          type: array
          items:
            $ref: '#/components/schemas/recipient'
          minItems: 1
      additionalProperties: false
    sender:
      type: object
      title: "Syst\xE8me \xE9metteur"
      x-display: expansion-panels
      x-health-only: false
      required:
      - name
      - URI
      properties:
        name:
          type: string
          title: "Nom du syst\xE8me emetteur"
          x-health-only: false
          x-cols: 6
          example: example.json#/sender/name
          description: "Identifiant technique du syst\xE8me emetteur\nFormat : \n\
            => Pour les SAMU : {nom solution LRM}-{cl\xE9 de routage}\no\xF9 cl\xE9\
            \ de routage d\xE9signe le nom de la cl\xE9 de routage utilis\xE9e par\
            \ le LRM pour les \xE9changes et {nom solution LRM} est le nom donn\xE9\
            \ par l'\xE9diteur \xE0 sa solution (libre)\n=> Pour NeXSIS : \xE0 d\xE9\
            finir {sga|sgo}-nexsis"
          examples:
          - sga-nexsis
        URI:
          type: string
          title: URI (identifiant technique)
          x-health-only: false
          x-cols: 6
          example: example.json#/sender/URI
          description: "uri du syst\xE8me. Permet d'identifier le vecteur utilis\xE9\
            \ par les \xE9changes\nFormat :\n=> Pour les LRM : {nom \xE9diteur}:{sender:name}\n\
            => Pour NexSIS : sge:{sender:name}"
          examples:
          - sge:sga-nexsis
      additionalProperties: false
      example: example.json#/sender
      examples:
      - name: sga-nexsis
        URI: sge:sga-nexsis
    recipient:
      type: object
      title: "Syst\xE8me destinataire"
      x-display: expansion-panels
      x-health-only: false
      required:
      - name
      - URI
      properties:
        name:
          type: string
          title: "Identifiant technique du syst\xE8me destinataire"
          x-health-only: false
          x-cols: 6
          example: example.json#/recipient/0/name
          description: "Identifiant technique du syst\xE8me emetteur\nFormat : \n\
            => Pour les SAMU : {cl\xE9 de routage}-{nom solution LRM}\no\xF9 cl\xE9\
            \ de routage d\xE9signe le nom de la cl\xE9 de routage utilis\xE9e par\
            \ le LRM pour les \xE9changes et {nom solution LRM} est le nom donn\xE9\
            \ par l'\xE9diteur \xE0 sa solution (libre)\n=> Pour NeXSIS : \xE0 d\xE9\
            finir {sga|sgo}-nexsis"
          examples:
          - samu-77
        URI:
          type: string
          title: URI (identifiant technique)
          x-health-only: false
          x-cols: 6
          example: example.json#/recipient/0/URI
          description: "uri du syst\xE8me. Permet d'identifier le vecteur utilis\xE9\
            \ par les \xE9changes\nFormat :\n=> Pour les LRM : sge:{recipient:name}\n\
            => Pour NexSIS : sge:{recipient:name}"
          examples:
          - sge:samu-77
      additionalProperties: false
      example: example.json#/recipient/0
      examples:
      - name: samu-77
        URI: sge:samu-77
