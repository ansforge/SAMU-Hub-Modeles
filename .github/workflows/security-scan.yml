name: Reusable Security Scan

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for the scan'
        required: true
        type: string
      component-name:
        description: 'Component name for categories and artifacts'
        required: true
        type: string
      scan-dockerfile:
        description: 'Whether to scan Dockerfile'
        required: false
        type: boolean
        default: false
      semgrep-excludes:
        description: 'Additional Semgrep excludes (space-separated)'
        required: false
        type: string
        default: ''
      dependency-scan:
        description: 'Whether to run dependency vulnerability scan'
        required: false
        type: boolean
        default: false

jobs:
  dependency-scan:
    runs-on: ubuntu-latest
    name: Dependency Vulnerability Scanning
    if: inputs.dependency-scan
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install and run Python dependency scanner
        if: hashFiles(format('{0}/uv.lock', inputs.working-directory)) != ''
        env:
          WORKING_DIR: ${{ inputs.working-directory }}
        run: |
          pip install uv-secure
          uv-secure "$WORKING_DIR/uv.lock" --format json > "$WORKING_DIR/uv-secure.json" || true

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scanning
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    strategy:
      fail-fast: false
      matrix:
        scan-config:
          - name: semgrep
            tool: semgrep
            output-file: semgrep.sarif
            category: semgrep
            condition: true
          - name: trivy-filesystem
            tool: trivy
            scan-type: fs
            scan-ref: ${{ inputs.working-directory }}
            scanners: vuln,secret,config
            output-file: trivy-filesystem.sarif
            category: trivy-filesystem
            condition: true
          - name: trivy-dockerfile
            tool: trivy
            scan-type: config
            scan-ref: ${{ inputs.working-directory }}/Dockerfile
            scanners: vuln,config
            output-file: trivy-dockerfile.sarif
            category: trivy-dockerfile
            condition: ${{ inputs.scan-dockerfile }}

    env:
      SEMGREP_EXCLUDES: "--exclude='.git' --exclude='node_modules' --exclude='dist' --exclude='build' --exclude='coverage' --exclude='__pycache__' --exclude='.venv' --exclude='.cache' --exclude='.pytest_cache' --exclude='.tox' --exclude='.mypy_cache' --exclude='uv.lock' --exclude='*.pyc' --exclude='*.min.js' --exclude='*.bundle.js' --exclude='.gradle' --exclude='gradle/wrapper' --exclude='*.class' --exclude='*.jar'"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Run Semgrep scan
        if: matrix.scan-config.tool == 'semgrep' && matrix.scan-config.condition
        env:
          OUTPUT_FILE: ${{ matrix.scan-config.output-file }}
          ADDITIONAL_EXCLUDES: ${{ inputs.semgrep-excludes }}
        run: |
          pip install semgrep
          if [ -n "$ADDITIONAL_EXCLUDES" ] && [ "$ADDITIONAL_EXCLUDES" != "" ]; then
            semgrep --config auto --sarif --output "$OUTPUT_FILE" \
              $SEMGREP_EXCLUDES \
              "$ADDITIONAL_EXCLUDES"
          else
            semgrep --config auto --sarif --output "$OUTPUT_FILE" \
              $SEMGREP_EXCLUDES
          fi

      - name: Run Trivy scan
        if: matrix.scan-config.tool == 'trivy' && matrix.scan-config.condition
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: ${{ matrix.scan-config.scan-type }}
          scan-ref: ${{ matrix.scan-config.scan-ref }}
          scanners: ${{ matrix.scan-config.scanners }}
          format: sarif
          output: ${{ inputs.working-directory }}/${{ matrix.scan-config.output-file }}
          ignore-unfixed: true
          exit-code: '0'

      - name: Fix SARIF file paths for GitHub Security tab
        if: matrix.scan-config.condition && always() && hashFiles(format('{0}/{1}', inputs.working-directory, matrix.scan-config.output-file)) != ''
        uses: ./.github/actions/fix-trivy-sarif
        with:
          sarif-file: '${{ inputs.working-directory }}/${{ matrix.scan-config.output-file }}'
          scan-path: '${{ inputs.working-directory }}'

      - name: Upload ${{ matrix.scan-config.name }} results to GitHub Security tab
        if: matrix.scan-config.condition
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ inputs.working-directory }}/${{ matrix.scan-config.output-file }}
          category: ${{ matrix.scan-config.category }}-${{ inputs.component-name }}

  upload-artifacts:
    runs-on: ubuntu-latest
    name: Upload Security Artifacts
    needs: [dependency-scan, security-scan]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # Upload all security reports as artifacts
      - name: Upload Security scan reports as artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ inputs.component-name }}
          path: |
            ${{ inputs.working-directory }}/*.sarif
            ${{ inputs.working-directory }}/*.json
          retention-days: 7
          if-no-files-found: ignore